import{ResolverOptions,IntermediateSearchResults,SearchResults,EnrichedSearchResults}from"./type.js";import Index from"./index.js";import Document from"./document.js";import WorkerIndex from"./worker.js";import default_resolver from"./resolve/default.js";import"./resolve/handler.js";import"./resolve/or.js";import"./resolve/and.js";import"./resolve/xor.js";import"./resolve/not.js";import{apply_enrich}from"./document/search.js";export default function Resolver(a,b){if(!this||this.constructor!==Resolver)return new Resolver(a,b);let c,d,e,f=0;if(a&&a.index){const c=a;if(b=c.index,f=c.boost||0,c.query){const d=c.resolve,e=c.async||c.queue;c.resolve=!1,c.index=null,a=e?b.searchAsync(c):b.search(c),c.resolve=d,c.index=b,a=a.result||a}else a=[]}if(a&&a.then){const b=this;a=a.then(function(a){b.promises[0]=b.result=a.result||a,b.execute()}),c=[a],a=[],d=new Promise(function(a){e=a})}this.index=b||null,this.result=a||[],this.boostval=f,this.promises=c||[],this.await=d||null,this.return=e||null}Resolver.prototype.limit=function(a){if(this.result.length){const b=[];for(let c,d=0;d<this.result.length;d++)if(c=this.result[d])if(!(c.length<=a)){b[d]=c.slice(0,a);break}else if(b[d]=c,a-=c.length,!a)break;this.result=b}return this},Resolver.prototype.offset=function(a){if(this.result.length){const b=[];for(let c,d=0;d<this.result.length;d++)(c=this.result[d])&&(c.length<=a?a-=c.length:(b[d]=c.slice(a),a=0));this.result=b}return this},Resolver.prototype.boost=function(a){return this.boostval+=a,this},Resolver.prototype.execute=function(a){let b=this.result;for(let c,d=0;d<this.promises.length;d++)if(c=this.promises[d],c)if("function"==typeof c)b=c(),this.promises[d]=b=b.result||b,d--;else if(c._fn)b=c._fn(),this.promises[d]=b=b.result||b,d--;else if(c.then)return this.await;const c=this.return;return this.result=b,this.promises=[],this.await=null,this.return=null,a||c(b),b},Resolver.prototype.resolve=function(a,b,c,d){let e=this.await?this.execute(!0):this.result;if(e.then){const d=this;return e.then(function(){return d.resolve(a,b,c)})}e.length&&("object"==typeof a&&(c=a.enrich,b=a.offset,!1,a=a.limit),e=d?c?apply_enrich.call(this.index,e):e:default_resolver.call(this.index,e,a||100,b,c));const f=this.return;return this.index=null,this.result=null,this.promises=null,this.await=null,this.return=null,f&&f(e),e};